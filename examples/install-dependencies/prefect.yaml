build:
  - prefect_oci.deployments.steps.install_dependencies_for_archiving:
      requires:
        - "prefect-oci @ git+https://github.com/bdalpe/prefect-oci.git"
      id: install_deps
      requirements_file: requirements.txt
      target_directory: deps
  
  - prefect_oci.deployments.steps.create_tar_archive:
      requires:
        - "prefect-oci @ git+https://github.com/bdalpe/prefect-oci.git"
      id: deps_archive
      sources:
        - "{{ install_deps.target_directory }}"

  - prefect_oci.deployments.steps.create_tar_archive:
      requires:
        - "prefect-oci @ git+https://github.com/bdalpe/prefect-oci.git"
      id: archive
      sources:
        - flow.py

push:
  - prefect.deployments.steps.run_shell_script:
      id: uuid
      script: python -c "import uuid; print(uuid.uuid4())"
      stream_output: false

  - prefect_oci.deployments.steps.push_oci_image:
      requires: "prefect-oci @ git+https://github.com/bdalpe/prefect-oci.git"
      name: "ttl.sh/{{ uuid.stdout }}"
      tag: "8h"
      layers:
        - "{{ deps_archive.output_path }}"
        - "{{ archive.output_path }}"

pull:
  - prefect_oci.deployments.steps.pull_oci_image:
      requires: "prefect-oci @ git+https://github.com/bdalpe/prefect-oci.git"
      name: "ttl.sh/{{ uuid.stdout }}"
      tag: "8h"

deployments:
  - name: "oci-dependency-test"
    entrypoint: "flow.py:simple_flow"
    schedules: null
